# Analysis Summaries

## What are Analysis Summaries?
Analysis summaries contain information about the functions that Coverity analyzed. Coverity can use this information instead of of the original source code to know relevant properties of the function, for instance, whether it dereferences one of its pointer arguments.

## How are they generated?
Analysis summaries are generated, per default, by `cov-analyze`. The generation can be controlled through the command-line parameter `--export-summaries <true|false>`. You can check whether analysis summaries have been generated by inspecting the console output:
```
****************************************************
[STATUS] Exporting summaries
|0----------25-----------50----------75---------100|
****************************************************
```

## Where are they stored?
Analysis summaries are stored in the intermediate directory in `output/exported-summaries/summaries`. During `cov-commit-defects`, they are uploaded to the target stream if Desktop Analysis is enabled for that stream.

## How are they used?
Analysis summaries are used by `cov-run-desktop`. When `cov-run-desktop` is asked to analyze a single file (or a set of files), it downloads analysis summaries from the Coverity Connect server. The analysis summaries allow `cov-run-desktop` to find interprocedural defects.

Consider the following example with files `foo.c` and `bar.c`. Neither of the functions has a bug in itself, however, when `bar()` calls `foo()` with a NULL pointer argument, it will lead to a NULL pointer exception in `bar()`. If both functions were analyzed in isolation, Coverity would not be able to find this code defect.
```
// FILE: bar.c
int bar()
{
   int *ip = 0;
   foo(ip); // Bug: NULL pointer dereferenced
}

// FILE: foo.c
int foo(int *p) 
{
  return *p;
}
```

When we run `cov-run-desktop bar.c`, it will download the analysis summaries from the Coverity Connect server. From the analysis summaries, it then knows that `foo()` will dereference its argument, so it knows that there is a defect.

## Performance
For very large projects, it can take a long time (10 minutes or more) to download analysis summaries from the Connect server. This is often prohibitive for fast scans of change sets (for example, pull requests) in CI pipelines. In such edge cases, `cov-run-desktop` may be used in _disconnected mode_, without connecting to a Coverity Connect server. This setup requires more maintenance effort, because we need to manage the analysis summaries (and other things) on our own, but it can provide significant performance benefits.

## Using analysis summaries in disconnected mode
We can use analysis summaries directly in `cov-run-desktop` without first uploading and then downloading them from the Coverity Connect server. This allows to use analysis summaries, and thus accurate incremental analysis, even when using `cov-run-desktop` in disconnected mode.

### Step 1: Perform full analysis and generate analysis summaries
```
git clone https://github.com/ioquake/ioq3
git checkout 6387c33
cov-build --dir idir-6387c33 make
cov-analyze --dir idir-6387c33 --strip-path `pwd`
```

### Step 2: Copy analysis summaries into the folder where cov-run-desktop looks for them
```
mkdir idir-6387c33/emit/desktop-cache
cp idir-6387c33/output/exported-summaries/summaries idir-6387c33/emit/desktop-cache
```

### Step 3: Perform incremental analysis
Since the analysis summaries are in the `desktop-cache` folder, `cov-run-desktop` will automatically pick them up.
```
git checkout 70d07d9
cov-run-desktop --disconnected --dir idir-6387c33 code/game/g_combat.c
```

Note the differences in the console output when analysis summaries are not found
```
[WARNING] Some summaries were not available because of disconnected operation.
```
If analysis summaries are present and used, `cov-run-desktop` will find an additional `FORWARD_NULL` defect that is similar to the example above. This defect cannot be found without analysis summaries, thus, the second run below only reports 3 defects.

<details>
 <summary>Output with analysis summaries</summary>

```
Coverity Desktop Analysis version 2022.9.1 on Linux 5.15.0-53-generic x86_64
cov-run-desktop operating in disconnected mode due to user request.
Selected 1 translation unit for analysis:
* code/game/g_combat.c

[STATUS] Parsing source files...
[STATUS] Analyzing...

Detected 4 defect occurrences that pass the filter criteria.

code/game/g_combat.c:546:2: CID (unavailable; MK=32e13339023b28fb69247f1890240eb7) (#1 of 1):
  Type: Dereference after null check (FORWARD_NULL)
  Triage unavailable.
code/game/g_combat.c:442:2:
  1. path: Condition "self->client->ps.pm_type == PM_DEAD", taking false branch.
code/game/g_combat.c:446:2:
  2. path: Condition "level.intermissiontime", taking false branch.
code/game/g_combat.c:455:2:
  3. path: Condition "self->client", taking true branch.
code/game/g_combat.c:455:2:
  4. path: Condition "self->client->hook", taking true branch.
code/game/g_combat.c:467:2:
  5. path: Condition "attacker", taking false branch.
code/game/g_combat.c:479:2:
  6. path: Condition "killer < 0", taking false branch.
code/game/g_combat.c:479:2:
  7. path: Condition "killer >= 64", taking true branch.
code/game/g_combat.c:484:2:
  8. path: Condition "meansOfDeath < 0", taking true branch.
code/game/g_combat.c:486:2:
  9. path: Falling through to end of if statement.
code/game/g_combat.c:505:2:
  10. path: Condition "attacker", taking false branch.
code/game/g_combat.c:505:2:
  11. var_compare_op: Comparing "attacker" to null implies that "attacker" might be null.
code/game/g_combat.c:546:2:
  12. var_deref_model: Passing null pointer "attacker" to "Team_FragBonuses", which dereferences it.

code/game/g_combat.c:455:6: CID (unavailable; MK=790a8c7de09fedb2cca816716d4f3183) (#1 of 1):
  Type: Dereference before null check (REVERSE_INULL)
  Triage unavailable.
code/game/g_combat.c:442:7:
  deref_ptr: Directly dereferencing pointer "self->client".
code/game/g_combat.c:455:6:
  check_after_deref: Null-checking "self->client" suggests that it may be null, but it has already been dereferenced on all paths leading to the check.

code/game/g_combat.c:997:4: CID (unavailable; MK=90f44a11aee1c826b91139cfba469562) (#1 of 1):
  Type: Logically dead code (DEADCODE)
  Triage unavailable.
code/game/g_combat.c:834:3:
  addr_non_null: The address of an object "&g_entities[1022]" is never null.
code/game/g_combat.c:837:3:
  assignment: Assigning: "attacker" = "&g_entities[1022]".
code/game/g_combat.c:994:8:
  notnull: At condition "attacker", the value of "attacker" cannot be "NULL".
code/game/g_combat.c:994:3:
  dead_error_condition: The condition "attacker" must be true.
code/game/g_combat.c:997:4:
  dead_error_line: Execution cannot reach this statement: "client->ps.persistant[PERS_...".

code/game/g_combat.c:994:8: CID (unavailable; MK=9be3465e8678eeca4dd05194d486c67d) (#1 of 1):
  Type: Dereference before null check (REVERSE_INULL)
  Triage unavailable.
code/game/g_combat.c:854:7:
  deref_ptr: Directly dereferencing pointer "attacker".
code/game/g_combat.c:994:8:
  check_after_deref: Null-checking "attacker" suggests that it may be null, but it has already been dereferenced on all paths leading to the check.

cov-run-desktop took 2.4 seconds.
```
</details>

<details>
 <summary>Output without analysis summaries</summary>

```
cov-run-desktop --disconnected --dir idir-6387c33 code/game/g_combat.c
Coverity Desktop Analysis version 2022.9.1 on Linux 5.15.0-53-generic x86_64
cov-run-desktop operating in disconnected mode due to user request.
Selected 1 translation unit for analysis:
* code/game/g_combat.c

[STATUS] Parsing source files...
[STATUS] Analyzing...
[WARNING] The checker "ARRAY_VS_SINGLETON" was disabled because it requires summaries.
[WARNING] The checker "CHECKED_RETURN" was disabled because it requires summaries.
[WARNING] The checker "NULL_RETURNS" was disabled because it requires summaries.
[WARNING] The checker "MISSING_MOVE_ASSIGNMENT" was disabled because it requires summaries.
[WARNING] Some summaries were not available because of disconnected operation.
Operating in single-file mode.
This may affect results.

Detected 3 defect occurrences that pass the filter criteria.

code/game/g_combat.c:455:6: CID (unavailable; MK=790a8c7de09fedb2cca816716d4f3183) (#1 of 1):
  Type: Dereference before null check (REVERSE_INULL)
  Triage unavailable.
code/game/g_combat.c:442:7:
  deref_ptr: Directly dereferencing pointer "self->client".
code/game/g_combat.c:455:6:
  check_after_deref: Null-checking "self->client" suggests that it may be null, but it has already been dereferenced on all paths leading to the check.

code/game/g_combat.c:997:4: CID (unavailable; MK=90f44a11aee1c826b91139cfba469562) (#1 of 1):
  Type: Logically dead code (DEADCODE)
  Triage unavailable.
code/game/g_combat.c:834:3:
  addr_non_null: The address of an object "&g_entities[1022]" is never null.
code/game/g_combat.c:837:3:
  assignment: Assigning: "attacker" = "&g_entities[1022]".
code/game/g_combat.c:994:8:
  notnull: At condition "attacker", the value of "attacker" cannot be "NULL".
code/game/g_combat.c:994:3:
  dead_error_condition: The condition "attacker" must be true.
code/game/g_combat.c:997:4:
  dead_error_line: Execution cannot reach this statement: "client->ps.persistant[PERS_...".

code/game/g_combat.c:994:8: CID (unavailable; MK=9be3465e8678eeca4dd05194d486c67d) (#1 of 1):
  Type: Dereference before null check (REVERSE_INULL)
  Triage unavailable.
code/game/g_combat.c:854:7:
  deref_ptr: Directly dereferencing pointer "attacker".
code/game/g_combat.c:994:8:
  check_after_deref: Null-checking "attacker" suggests that it may be null, but it has already been dereferenced on all paths leading to the check.

cov-run-desktop took 2.3 seconds.
```
</details>

